# MySQL架构

MySQL架构可以分为**Service层**和**存储引擎层**.这只是人为的从功能逻辑上进行的划分

Service层的主要功能:**连接管理**和**解析优化**

## 连接管理

> 1. MySQL采用**客户端-服务器**(C-S)架构,客户端主要向服务器发送增改删查请求,并接收服务器响应回来的结果.服务器主要负责解析并执行客户端的请求,并将结果返回.一个MySQL服务器进程也称为一个MySQL实例.通过**TCP**进行连接.
> 2. 像我们使用的navicat软件,或者自带mysql命令都是客户端,我们的Java程序也是客户端.
> 3. MySQL服务器有TCP连接池,采用长连接模式复用TCP连接,管理和客户端的连接.在和客户端建立连接后,还需分配一个线程去执行,所以还有线程池.
> 4. 以上都是连接管理的内容,负责认证,管理连接,获取权限信息.

## 解析优化

> 1. 客户端传来的SQL请求,本质上就是字符串,需要进行解析后,才能交给执行引擎执行,这个过程类似于编译.
> 2. 5.7.20之前有查询缓存优化,将查询字符串作为key,对应的缓存结果作为value,但是维护开销大,不建议使用.
> 3. 之后是分析器 ==> 优化器 ==> 执行器
> 4. **分析器**主要是对SQL字符串进行语法解析,如果`SQL`字符串不符合语法规范，就会收到`You have an error in your SQL syntax`错误提醒.通过了**分析器**，说明`SQL`字符串符合语法规范，现在`MySQL`服务器要执行`SQL`语句了
> 5. **优化器**主要利用分析器的结果,生成对应的执行计划,通常会进行一定的性能权衡(时间消耗),生成合适的执行计划,还会优化SQL语句.
> 6. **执行器**开始执行的时候，要先判断一下对这个表有没有相应的权限，如果没有，就会返回权限错误。如果有权限，根据执行计划调用存储引擎`API`对表进行的读写。
> 7. 存储引擎`API`只是抽象接口，下面还有个**存储引擎层**，具体实现还是要看表选择的存储引擎。屏蔽了存储引擎的底层细节.
> 8. 解析优化主要负责:
>    + 缓存
>    + SQL语法解析验证
>    + QL优化并生成执行计划
>    + 根据执行计划调用存储引擎接口

## 小结

**连接管理、解析与优化**这些并不涉及读写表数据的组件划分到`Servce`层，读写表数据而是交给**存储引擎层**来做。

通过这种架构设计，我们发现`Servce`层其实就是公用层，**存储引擎层**就是多态层，按需选择具体的存储引擎。

再细想下，它和**模板方法设计模式**一摸一样，它们的执行流程是固定的，`Servce`层等于公用模板函数，**存储引擎层**等于抽象模板函数，按需子类实现。